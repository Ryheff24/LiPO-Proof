# Formal Verification of the Generative Pipeline Hypothesis

[![Verify Lean Proofs](https://github.com/Ryheff24/LiPO-Proof/actions/workflows/verify.yml/badge.svg)](https://github.com/Ryheff24/LiPO-Proof/actions/workflows/verify.yml)

Lean 4 proofs supporting the paper *"Generative Pipeline Hypothesis in Recommendation Systems: On the Structural Limitations of Listwise Preference Optimization via LambdaRank Objectives"* by Ryan Heffernan.

All proofs were generated by [Aristotle](https://aristotle.harmonic.fun) (Harmonic) and verified by the Lean 4 kernel.

## Environment

- **Lean:** `leanprover/lean4:v4.24.0`
- **Mathlib:** `f897ebcf72cd16f89ab4577d0c826cd14afaafc7`

## What "Verified" Means

These proofs are not checked by a human or by AI — they are checked by Lean's **kernel**, a small deterministic program that mechanically validates every logical step from axioms to conclusion. If the file compiles with no errors or `sorry` placeholders, the proof is correct. Linter warnings (unused variables, deprecated names) are cosmetic and do not affect validity.

## Proof Files

### Core Results (Paper Foundations)

| File | Paper Reference | Result |
|------|----------------|--------|
| `Lipo/submodular.lean` | Example 4.1 | **Coverage utility is submodular.** For any collection of subsets C indexed by a finite set I, the function U(S) = \|⋃\_{i∈S} C(i)\| satisfies the diminishing returns property. |
| `Lipo/maximized.lean` | Lemma 3.1 | **Rearrangement inequality for rankings.** If v is strictly decreasing and g is strictly increasing, then Σ v(k)·g(r\_{π(k)}) is maximized when π sorts r in descending order. |
| `Lipo/argmax.lean` | Lemma 4.2 | **NDCG-optimal set equals top-K by gain.** Any set S of size K that maximizes DCG (over all internal orderings) must consist of the K items with the largest gain values. Proved via an exchange lemma. |

### Main Theorems

| File | Paper Reference | Result |
|------|----------------|--------|
| `Lipo/coverage.lean` | Theorem 4.3 | **Submodular misalignment gap is Ω(K).** Constructs K groups of K items where the relevance-optimal set achieves coverage utility 1, while the coverage-optimal set achieves K. The ratio U(S\*)/U(T) = K. |
| `Lipo/gini.lean` | Section 3 (new) | **Gini lower bound under head/tail concentration.** If items are partitioned into head H and tail T with all head exposures ≥ all tail exposures and 2\|H\| ≤ n, then G ≥ ((E\_H − E\_T)/(E\_H + E\_T))·(1 − \|H\|/n). Includes a counterexample showing the assumption \|H\| ≤ n/2 is necessary. |

### Strengthening Results

| File | Paper Reference | Result |
|------|----------------|--------|
| `Lipo/approximationgreed.lean` | Section 4.4 | **Nemhauser-Wolsey-Fisher (1978).** For monotone submodular maximization under a cardinality constraint, the greedy algorithm achieves a (1 − 1/e) ≈ 0.632 approximation ratio. Combined with Theorem 4.3, this shows greedy submodular-aware methods provably achieve ≥ 63% of optimal, while NDCG can achieve as little as 1/K. |

### Setup

| File | Description |
|------|-------------|
| `Lipo/Prelude.lean` | Imports Mathlib and sets compiler options. |

## Logical Dependencies

```
Prelude.lean
  ├── submodular.lean ─────────────┐
  ├── maximized.lean ──┐           │
  │                    ├── argmax.lean ──┤
  ├── coverage.lean ───────────────┤ → Hypothesis II chain
  ├── gini.lean ───────────────────┤ → Hypothesis I chain
  └── approximationgreed.lean ─────┘
```

## How the Proofs Support the Paper

### Hypothesis II (Homogeneous Recommendations) — Proof Chain Complete

The paper's central claim is that NDCG-optimized LiPO produces homogeneous recommendations when user utility is submodular. The verified proof chain:

1. **NDCG picks top-K by individual gain** (`argmax.lean`) — NDCG optimization reduces to selecting the K highest-gain items, an additive objective.
2. **Coverage utility is submodular** (`submodular.lean`) — User utility over diverse content exhibits diminishing returns.
3. **Additive-optimal can be Ω(K) worse than submodular-optimal** (`coverage.lean`) — The gap between what NDCG selects and what maximizes user utility can grow linearly with list size.
4. **Greedy submodular methods achieve (1−1/e) of optimal** (`approximationgreed.lean`) — Known algorithms provably do much better than NDCG at capturing submodular utility.

Under Assumption 4.2 of the paper (high-relevance items tend to be similar), these results establish that LiPO-optimized policies produce recommendations with higher homogeneity and lower realized user utility than diversity-aware alternatives.

### Hypothesis I (Long-Tail Exposure Inequality) — Foundation Verified

1. **NDCG-optimal rankings sort by relevance** (`maximized.lean`) — Under long-tail distributions, this concentrates exposure on head items.
2. **Gini lower bound** (`gini.lean`) — Quantifies the minimum exposure inequality when exposure is concentrated in a small head set.

## Building

```bash
# Requires Lean 4 and Mathlib
lake build
```

## Citation

If you use these proofs, please cite both the paper and Aristotle:

```bibtex
@article{heffernan2026generative,
  title={Generative Pipeline Hypothesis in Recommendation Systems: 
         On the Structural Limitations of Listwise Preference 
         Optimization via LambdaRank Objectives},
  author={Heffernan, Ryan},
  year={2026}
}
```

All proof files include Aristotle attribution headers. Per Harmonic's guidelines, add as co-author to commits:

```
Co-authored-by: Aristotle (Harmonic) <aristotle-harmonic@harmonic.fun>
```

## License

This project is licensed under the Apache License 2.0 — see [LICENSE](LICENSE) for details.